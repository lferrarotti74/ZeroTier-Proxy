name: Unit Tests

on:
  # Run tests on dev branch pushes (active development)
  push:
    branches: [dev]
  
  # Run tests on PRs to both branches with smart exclusions
  pull_request:
    branches: [dev, main]
    paths-ignore:
      # Skip tests for Dependabot workflow updates
      - '.github/workflows/**'
      
      # Documentation files
      - '*.md'
      - 'docs/**'
      - '.github/**/*.md'
      
      # License and legal files
      - 'LICENSE*'
      - 'COPYING*'
      - 'COPYRIGHT*'
      
      # Git and GitHub specific files
      - '.gitignore'
      - '.gitattributes'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/dependabot.yml'
      - '.github/CODEOWNERS'
      
      # Editor and IDE files
      - '.vscode/**'
      - '.idea/**'
      - '*.swp'
      - '*.swo'
      - '*~'
      
      # Package manager files that don't affect builds
      - '.npmignore'
      - '.dockerignore'
      - '.eslintignore'
      - '.prettierignore'
      
      # CI/CD configuration for other systems
      - '.travis.yml'
      - '.circleci/**'
      - 'Jenkinsfile'
      - '.gitlab-ci.yml'
      
      # Common non-code files
      - '*.txt'
      - 'CHANGELOG*'

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5.2.0

      - name: Set Environment
        uses: c-py/action-dotenv-to-setenv@925b5d99a3f1e4bd7b4e9928be4e2491e29891d9 # v5
        id: source-env
        with:
          env-file: env/.env
          
      - name: Echo ZeroTier-Proxy Version from env file
        run: |
          echo ${{ steps.source-env.outputs.zerotierproxy_version }} >> "$GITHUB_ENV"

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build ZeroTier-Proxy test image
        run: |
          docker build \
            --build-arg VERSION=${{ env.ZEROTIERPROXY_VERSION }} \
            --tag zerotier-proxy:test \
            .

      - name: Install BATS testing framework and docker-compose
        run: |
          sudo apt-get update
          sudo apt-get install -y bats docker-compose

      - name: Install additional testing tools
        run: |
          sudo apt-get install -y jq netcat-openbsd curl

      - name: Run container build and functionality tests
        run: |
          bats tests/container/

      - name: Run compose functionality tests
        run: |
          bats tests/compose/

      - name: Run script validation tests
        run: |
          bats tests/scripts/

      - name: Run security validation tests
        run: |
          bats tests/security/

      - name: Generate test report
        if: always()
        run: |
          echo "ZeroTier-Proxy Test Summary" > test-report.txt
          echo "===========================" >> test-report.txt
          echo "Container tests: $(find tests/container/ -name '*.bats' 2>/dev/null | wc -l) test files" >> test-report.txt
          echo "Compose tests: $(find tests/compose/ -name '*.bats' 2>/dev/null | wc -l) test files" >> test-report.txt
          echo "Script tests: $(find tests/scripts/ -name '*.bats' 2>/dev/null | wc -l) test files" >> test-report.txt
          echo "Security tests: $(find tests/security/ -name '*.bats' 2>/dev/null | wc -l) test files" >> test-report.txt
          echo "Total test files: $(find tests/ -name '*.bats' 2>/dev/null | wc -l)" >> test-report.txt
          cat test-report.txt

      - name: Cleanup test resources
        if: always()
        run: |
          # Clean up any remaining test containers
          docker ps -a --filter "name=zerotier-proxy-test" --format "{{.Names}}" | xargs -r docker rm -f
          # Clean up test image (only at workflow end)
          docker rmi zerotier-proxy:test || true
          # Clean up any dangling images
          docker image prune -f